language: node_js
# Use java build image (u14nodall:tip is also an option) so we've got JDK8 which selenium requires
build_image: drydock/u14javall:prod

node_js:
  - 7.0.0

services:
  - selenium

addons:
    firefox: "49.0"

env:
  global:
    # BLUEMIX_USER and BLUEMIX_PASSWORD encrypted as cambridgeweblab
    - secure: Gpzuk51B3s6Ew2Z+29YqzFmEhGz7bwt8Lm9ak8mzOWmLHiKIQ8GLdSff/IV5pdjAbSe3OyVi8ywRy5LFE5X1pDvuW4LCviKUyMj3hl6J6I3DWMausXPoea8ToYeSrZzVF9rO4WL39kIO80NSV4fGVD1nLWrk3kuBFoeebrdgqlovP7A8Wa4CTKNcAaq7IIgtRuM5TyBgcAJKYDLv/IepdfJdFvhdDyuo/KNK9MxQRSURwckHHkczau7guY7SfhY9zv5IFX0HmIyrjFlY0eAE/HYwjha47CIS2IBMhtecQrgR5EeVOdac9EsMOt0Tj8+U124SIkFP6X2bFArNeB3QxQ==
    - SHIPPABLE_SELENIUM_BINARY=/usr/local/selenium/selenium-server-standalone-2.45.0.jar

build:

  ci:
  - curl -O https://s3-us-west-1.amazonaws.com/cf-cli-releases/releases/v6.22.2/cf-cli-installer_6.22.2_x86-64.deb
  - SUDO=$(which sudo) && $SUDO dpkg -i cf-cli-installer_6.22.2_x86-64.deb
  # Already installed on java image - sudo apt-get install xvfb
  - export DISPLAY=:99.0

  - npm install bower
  - npm install
  # Change geckodriver to one that is appropriate for version of Firefox
  - npm uninstall geckodriver
  - npm install geckodriver@1.4.0
  # Version of Chromedriver that has support for Chrome 48. See https://chromedriver.storage.googleapis.com/2.27/notes.txt
  - npm uninstall chromedriver
  - npm install chromedriver@2.21
  # Make sure we don't get the old ones
  - rm -rf node_modules/selenium-standalone/.selenium/chromedriver/
  - rm -rf node_modules/selenium-standalone/.selenium/geckodriver/
  - ./node_modules/bower/bin/bower install --allow-root
  - mkdir -p shippable/buildoutput
  - xvfb-run --server-args="-ac" npm test

  on_success:
  - cf login -a https://api.eu-gb.bluemix.net -o "Web Lab" -u $BLUEMIX_USER -s dev -p $BLUEMIX_PASSWORD
  - cp -rv package.json index.js bower_components/ components/ examples/  ./shippable/buildoutput
  - cd shippable/buildoutput && ls -la && cf push common-ui -t 120 -c "node index.js"
  - cf target -s stable
  - cf push common-ui -t 120 -c "node index.js"

integrations:
  notifications:
    - integrationName: hipchat
      type: hipchat
      recipients:
        - '#Common%20UI'
      branches:
        only:
          - master
      on_success: always
      on_failure: always
